
<#
.SYNOPSIS
    Interactive console menu utilities.
.DESCRIPTION
    Provides interactive, text-based selection menus for choosing categories,
    toggling options, and printing a configuration summary.
.NOTES
    Designed for PowerShell console UX; uses Clear-Host and Read-Host.
#>

function Show-Menu {
    <#
    .SYNOPSIS
        Renders an interactive checkbox-style menu.
    .DESCRIPTION
        Displays options with selection markers and optional descriptions. Users
        can toggle items by number, select all/none/recommended, and press Enter
        to accept the current selection.
    .PARAMETER Title
        Menu title displayed at the top.
    .PARAMETER Options
        Array of hashtables with keys: Label, Selected, Description, Icon, Disabled.
    .PARAMETER Legend
        Optional legend text shown under the list.
    .PARAMETER AllowMultiple
        Indicates whether multi-select is allowed (kept for future extensibility).
    .OUTPUTS
        [int[]] Indices of selected items.
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$Title,

        [Parameter(Mandatory=$true)]
        [array]$Options,

        [string]$Legend = "",

        [bool]$AllowMultiple = $true
    )

    $selectedIndices = @()

    do {
        Clear-Host

        Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
        Write-Host "    $Title" -ForegroundColor Cyan
        Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
        Write-Host ""

        for ($i = 0; $i -lt $Options.Count; $i++) {
            $option = $Options[$i]
            $index = $i + 1

            $checkbox = if ($option.Selected) { "X" } else { " " }

            $icon = if ($option.Icon) { " $($option.Icon)" } else { "" }

            $color = "White"
            if ($option.Disabled) {
                $color = "DarkGray"
            } elseif ($option.Icon -eq "[*]") {
                $color = "Green"
            } elseif ($option.Icon -eq "[!]") {
                $color = "Yellow"
            } elseif ($option.Icon -eq "[i]") {
                $color = "Cyan"
            }

            $line = " [$checkbox] $index. $($option.Label)$icon"
            Write-Host $line -ForegroundColor $color

            if ($option.Description) {
                Write-Host "      $($option.Description)" -ForegroundColor DarkGray
            }
        }

        if ($Legend) {
            Write-Host ""
            Write-Host "Legend: $Legend" -ForegroundColor DarkGray
        }

        Write-Host ""
        Write-Host "Toggle with numbers, 'A' for all, 'N' for none, 'R' for recommended, Enter to continue" -ForegroundColor Yellow

        $choice = Read-Host "Your choice"

        if ($choice -match '^\d+$') {
            $idx = [int]$choice - 1
            if ($idx -ge 0 -and $idx -lt $Options.Count -and -not $Options[$idx].Disabled) {
                $Options[$idx].Selected = -not $Options[$idx].Selected
            }
        }
        elseif ($choice -eq 'A' -or $choice -eq 'a') {
            for ($i = 0; $i -lt $Options.Count; $i++) {
                if (-not $Options[$i].Disabled) {
                    $Options[$i].Selected = $true
                }
            }
        }
        elseif ($choice -eq 'N' -or $choice -eq 'n') {
            for ($i = 0; $i -lt $Options.Count; $i++) {
                $Options[$i].Selected = $false
            }
        }
        elseif ($choice -eq 'R' -or $choice -eq 'r') {
            for ($i = 0; $i -lt $Options.Count; $i++) {
                $Options[$i].Selected = ($Options[$i].Icon -eq "[*]")
            }
        }
        elseif ($choice -eq '') {
            break
        }

    } while ($true)

    $selectedIndices = @()
    for ($i = 0; $i -lt $Options.Count; $i++) {
        if ($Options[$i].Selected) {
            $selectedIndices += $i
        }
    }

    return $selectedIndices
}

function Show-CategoryMenu {
    <#
    .SYNOPSIS
        Presents a category selection menu.
    .DESCRIPTION
        Converts category metadata into menu options and returns the selected
        category keys in the original hash order.
    .PARAMETER Categories
        Hashtable of category definitions with Icon/ItemCount/Recommended metadata.
    .OUTPUTS
        [string[]] Selected category keys.
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [hashtable]$Categories
    )

    $options = @()
    $index = 0
    foreach ($key in $Categories.Keys) {
        $cat = $Categories[$key]
        $options += @{
            Label = "$($cat.Icon) $key"
            Selected = $true
            Description = "$($cat.ItemCount) items ($($cat.Recommended) recommended)"
            Icon = ""
        }
        $index++
    }

    $selectedIndices = Show-Menu -Title "SELECT CATEGORIES" -Options $options -AllowMultiple $true

    $categoryKeys = @($Categories.Keys)
    $selectedCategories = @()
    foreach ($idx in $selectedIndices) {
        $selectedCategories += $categoryKeys[$idx]
    }

    return $selectedCategories
}

function Get-UserChoice {
    <#
    .SYNOPSIS
        Prompts for a single validated choice.
    .DESCRIPTION
        Loops until the user enters one of the allowed choices, optionally
        accepting a default when Enter is pressed.
    .PARAMETER Prompt
        Prompt text shown to the user.
    .PARAMETER ValidChoices
        Array of allowed choices (strings).
    .PARAMETER DefaultChoice
        Optional default choice when user presses Enter.
    .OUTPUTS
        [string] Selected choice.
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$Prompt,

        [Parameter(Mandatory=$true)]
        [array]$ValidChoices,

        [string]$DefaultChoice = ""
    )

    do {
        $validString = $ValidChoices -join '/'
        if ($DefaultChoice) {
            $fullPrompt = "$Prompt [$validString, default=$DefaultChoice]"
        } else {
            $fullPrompt = "$Prompt [$validString]"
        }

        $choice = Read-Host $fullPrompt

        if ($choice -eq '' -and $DefaultChoice) {
            $choice = $DefaultChoice
        }

        if ($ValidChoices -contains $choice) {
            return $choice
        }

        Write-Host "Invalid choice. Please select from: $validString" -ForegroundColor Red

    } while ($true)
}

function Show-Summary {
    <#
    .SYNOPSIS
        Displays a configuration summary.
    .DESCRIPTION
        Prints a categorized view of the selected configuration with simple
        YES/NO mapping for boolean values.
    .PARAMETER Title
        Summary header text.
    .PARAMETER Config
        Hashtable of configuration values to display.
    .OUTPUTS
        None.
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$Title,

        [Parameter(Mandatory=$true)]
        [hashtable]$Config
    )

    Clear-Host
    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "    $Title" -ForegroundColor Cyan
    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""

    foreach ($category in $Config.Keys | Sort-Object) {
        Write-Host "${category}:" -ForegroundColor Yellow
        $items = $Config[$category]

        if ($items -is [hashtable]) {
            foreach ($key in $items.Keys | Sort-Object) {
                $value = $items[$key]
                $status = if ($value -eq $true) { "YES" } elseif ($value -eq $false) { "NO" } else { $value }
                Write-Host "  $key : $status" -ForegroundColor White
            }
        } elseif ($items -is [array]) {
            foreach ($item in $items) {
                Write-Host "  - $item" -ForegroundColor White
            }
        } else {
            Write-Host "  $items" -ForegroundColor White
        }

        Write-Host ""
    }

    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
}

function Show-Welcome {
    <#
    .SYNOPSIS
        Shows the interactive setup welcome screen.
    .DESCRIPTION
        Prints a banner and optional system information for user context.
    .PARAMETER SystemInfo
        Hashtable of system key/value pairs to display.
    .OUTPUTS
        None.
    #>

    [CmdletBinding()]
    param(
        [hashtable]$SystemInfo = @{}
    )

    Clear-Host
    Write-Host ""
    Write-Host "??\u0022?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "???                                                                              ???" -ForegroundColor Cyan
    Write-Host "???              GAMING PC SETUP - INTERACTIVE CONFIGURATION                     ???" -ForegroundColor Cyan
    Write-Host "???                                                                              ???" -ForegroundColor Cyan
    Write-Host "????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "Welcome! This wizard will optimize your Windows system for gaming." -ForegroundColor White
    Write-Host ""

    if ($SystemInfo.Count -gt 0) {
        Write-Host "System Information:" -ForegroundColor Yellow
        foreach ($key in $SystemInfo.Keys) {
            Write-Host "  $key : $($SystemInfo[$key])" -ForegroundColor White
        }
        Write-Host ""
    }
}

function Show-SetupModeSelection {
    <#
    .SYNOPSIS
        Presents the setup mode selection menu.
    .DESCRIPTION
        Lets the user choose between express, custom, or profile-based setup,
        or exit the wizard.
    .OUTPUTS
        [string] One of: express, custom, profile, exit.
    #>

    Clear-Host
    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "    SETUP MODE SELECTION" -ForegroundColor Cyan
    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "Choose your setup mode:" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "  1) Express Setup (Recommended)" -ForegroundColor Green
    Write-Host "     - Uses proven defaults" -ForegroundColor DarkGray
    Write-Host "     - ~5 minutes setup time" -ForegroundColor DarkGray
    Write-Host "     - Best for most users" -ForegroundColor DarkGray
    Write-Host ""
    Write-Host "  2) Custom Setup (Advanced)" -ForegroundColor Yellow
    Write-Host "     - Select each optimization individually" -ForegroundColor DarkGray
    Write-Host "     - ~15 minutes setup time" -ForegroundColor DarkGray
    Write-Host "     - Full control over every setting" -ForegroundColor DarkGray
    Write-Host ""
    Write-Host "  3) Load Profile" -ForegroundColor Cyan
    Write-Host "     - Pre-made configurations" -ForegroundColor DarkGray
    Write-Host "     - Competitive / Balanced / Privacy-Focused" -ForegroundColor DarkGray
    Write-Host ""
    Write-Host "  4) Exit" -ForegroundColor Red
    Write-Host ""

    $choice = Get-UserChoice -Prompt "Your choice" -ValidChoices @('1', '2', '3', '4') -DefaultChoice '1'

    switch ($choice) {
        '1' { return "express" }
        '2' { return "custom" }
        '3' { return "profile" }
        '4' { return "exit" }
    }
}


Export-ModuleMember -Function @(
    'Show-Menu',
    'Show-CategoryMenu',
    'Get-UserChoice',
    'Show-Summary',
    'Show-Welcome',
    'Show-SetupModeSelection'
)

